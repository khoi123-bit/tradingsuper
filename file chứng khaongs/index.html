<!doctype html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <title>LynxView | The Future of Analysis</title>
    <link rel="icon" type="image/png" href="·∫£nh.jpg" />
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@500&display=swap");
      :root {
        --bg: #0b0e11;
        --panel: #161a1e;
        --border: #2b2f36;
        --text: #eaecef;
        --gold: #fcd535;
        --up: #0ecb81;
        --down: #f6465d;
        --active: #2962ff;
        --input-bg: #24292e;
      }
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Inter", sans-serif;
        font-size: 11px;
      }
      body {
        background: var(--bg);
        color: var(--text);
        height: 100vh;
        overflow: hidden;
      }
      body.logged-in {
        display: grid;
        grid-template-columns: 48px 1fr 280px;
        grid-template-rows: 42px 1fr 180px;
      }

      /* LANDING PAGE */
      #landing-page {
        position: fixed;
        inset: 0;
        z-index: 10000;
        background: #0b0e11;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
      }
      .lp-header {
        height: 70px;
        padding: 0 50px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: rgba(11, 14, 17, 0.8);
        backdrop-filter: blur(10px);
        position: sticky;
        top: 0;
        border-bottom: 1px solid var(--border);
      }
      .lp-logo {
        display: flex;
        align-items: center;
        gap: 12px;
        font-size: 20px;
        font-weight: 800;
        color: #fff;
      }
      .lp-nav {
        display: flex;
        gap: 30px;
      }
      .lp-nav a {
        color: #848e9c;
        text-decoration: none;
        font-size: 14px;
        font-weight: 600;
        transition: 0.2s;
      }
      .lp-nav a:hover {
        color: #fff;
      }
      .lp-auth-btns {
        display: flex;
        gap: 15px;
      }
      .lp-btn {
        padding: 10px 24px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 700;
        cursor: pointer;
        transition: 0.2s;
        border: none;
      }
      .lp-btn-outline {
        background: transparent;
        border: 1px solid #474d57;
        color: #fff;
      }
      .lp-btn-outline:hover {
        border-color: #fff;
      }
      .lp-btn-gold {
        background: var(--gold);
        color: #181a20;
      }
      .lp-btn-gold:hover {
        background: #f0b90b;
      }

      .hero {
        padding: 120px 50px;
        text-align: center;
        background: radial-gradient(
          circle at center,
          rgba(41, 98, 255, 0.1) 0%,
          transparent 70%
        );
      }
      .hero h1 {
        font-size: 64px;
        font-weight: 900;
        color: #fff;
        margin-bottom: 24px;
        line-height: 1.1;
        animation: fadeInUp 0.8s ease-out forwards;
        opacity: 0;
      }
      .hero p {
        font-size: 20px;
        color: #848e9c;
        max-width: 700px;
        margin: 0 auto 40px;
        line-height: 1.6;
        animation: fadeInUp 0.8s ease-out 0.2s forwards;
        opacity: 0;
      }
      .hero .lp-btn-gold {
        animation:
          fadeInUp 0.8s ease-out 0.4s forwards,
          pulseGlow 2s infinite;
        opacity: 0;
      }
      .hero-stats {
        display: flex;
        justify-content: center;
        gap: 60px;
        margin-top: 80px;
        animation: fadeIn 1s ease-out 0.6s forwards;
        opacity: 0;
      }
      .stat-item h3 {
        font-size: 32px;
        color: var(--gold);
        margin-bottom: 8px;
        transition: transform 0.3s ease;
      }
      .stat-item:hover h3 {
        transform: scale(1.1);
      }
      .stat-item p {
        font-size: 14px;
        color: #848e9c;
      }

      .features {
        padding: 100px 50px;
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 40px;
        max-width: 1200px;
        margin: 0 auto;
      }
      .feat-card {
        background: #1e2329;
        padding: 40px;
        border-radius: 20px;
        border: 1px solid var(--border);
        transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        animation: fadeInUp 0.8s ease-out 0.8s forwards;
        opacity: 0;
      }
      .feat-card:nth-child(2) {
        animation-delay: 1s;
      }
      .feat-card:nth-child(3) {
        animation-delay: 1.2s;
      }

      .feat-card:hover {
        transform: translateY(-15px) scale(1.02);
        border-color: var(--gold);
        box-shadow:
          0 20px 40px rgba(0, 0, 0, 0.4),
          0 0 20px rgba(252, 213, 53, 0.1);
      }
      .feat-icon {
        font-size: 40px;
        margin-bottom: 24px;
        display: inline-block;
        transition: transform 0.5s ease;
      }
      .feat-card:hover .feat-icon {
        transform: rotateY(360deg);
      }

      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(30px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }
      @keyframes pulseGlow {
        0% {
          box-shadow: 0 0 0 0 rgba(252, 213, 53, 0.4);
        }
        70% {
          box-shadow: 0 0 0 15px rgba(252, 213, 53, 0);
        }
        100% {
          box-shadow: 0 0 0 0 rgba(252, 213, 53, 0);
        }
      }
      @keyframes floating {
        0% {
          transform: translateY(0px);
        }
        50% {
          transform: translateY(-10px);
        }
        100% {
          transform: translateY(0px);
        }
      }

      .lp-logo img {
        animation: floating 3s ease-in-out infinite;
      }
      .feat-card h4 {
        font-size: 20px;
        color: #fff;
        margin-bottom: 16px;
      }
      .feat-card p {
        font-size: 14px;
        color: #848e9c;
        line-height: 1.6;
      }

      /* AUTH MODAL */
      #auth-modal {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.9);
        z-index: 11000;
        display: none;
        align-items: center;
        justify-content: center;
        backdrop-filter: blur(5px);
      }
      .auth-container {
        display: flex;
        background: #1e2329;
        border-radius: 16px;
        overflow: hidden;
        width: 800px;
        max-width: 95vw;
        height: 550px;
        border: 1px solid #474d57;
        box-shadow: 0 25px 60px rgba(0, 0, 0, 0.8);
        position: relative;
      }
      .auth-branding {
        flex: 1;
        background: linear-gradient(135deg, #181a20 0%, #2b3139 100%);
        padding: 40px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        text-align: center;
        border-right: 1px solid var(--border);
        position: relative;
        overflow: hidden;
      }
      .auth-branding::before {
        content: "";
        position: absolute;
        inset: 0;
        background: radial-gradient(
          circle at 30% 30%,
          rgba(252, 213, 53, 0.1) 0%,
          transparent 70%
        );
      }
      .auth-branding img {
        height: 120px;
        margin-bottom: 30px;
        filter: drop-shadow(0 0 20px rgba(252, 213, 53, 0.3));
        z-index: 1;
      }
      .auth-branding h2 {
        font-size: 32px;
        font-weight: 800;
        color: #fff;
        margin-bottom: 15px;
        z-index: 1;
      }
      .auth-branding p {
        font-size: 14px;
        color: #848e9c;
        max-width: 250px;
        line-height: 1.6;
        z-index: 1;
      }
      .auth-box {
        width: 380px;
        padding: 50px;
        background: #1e2329;
        display: flex;
        flex-direction: column;
        justify-content: center;
      }
      .close-modal {
        position: absolute;
        top: 25px;
        right: 25px;
        color: #848e9c;
        cursor: pointer;
        font-size: 24px;
        z-index: 10;
        transition: 0.2s;
      }
      .close-modal:hover {
        color: #fff;
      }
      .auth-box h1 {
        font-size: 24px;
        font-weight: 800;
        margin-bottom: 8px;
        color: #fff;
      }
      @media (max-width: 800px) {
        .auth-container {
          flex-direction: column;
          height: auto;
          width: 90vw;
        }
        .auth-branding {
          padding: 30px;
          height: 200px;
        }
        .auth-branding img {
          height: 60px;
          margin-bottom: 10px;
        }
        .auth-branding h2 {
          font-size: 24px;
        }
        .auth-branding p {
          font-size: 12px;
        }
        .auth-box {
          width: 100%;
          padding: 30px;
        }
      }
      .auth-box p {
        color: #848e9c;
        margin-bottom: 30px;
        font-size: 13px;
      }
      .auth-tab {
        display: flex;
        margin-bottom: 25px;
        gap: 20px;
      }
      .tab {
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        color: #848e9c;
        padding-bottom: 8px;
        position: relative;
      }
      .tab.active {
        color: var(--gold);
      }
      .tab.active::after {
        content: "";
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100%;
        height: 2px;
        background: var(--gold);
      }
      .auth-input-wrap {
        margin-bottom: 20px;
      }
      .auth-input-wrap label {
        display: block;
        margin-bottom: 8px;
        color: #eaecef;
        font-weight: 500;
        font-size: 12px;
      }
      .auth-input {
        width: 100%;
        padding: 14px;
        background: #2b3139;
        border: 1px solid transparent;
        color: #fff;
        border-radius: 8px;
        outline: none;
        font-size: 14px;
      }
      .auth-input:focus {
        border-color: var(--gold);
      }
      .auth-btn {
        width: 100%;
        padding: 15px;
        background: var(--gold);
        border: none;
        color: #181a20;
        font-weight: 800;
        cursor: pointer;
        border-radius: 8px;
        font-size: 15px;
        margin-top: 10px;
      }

      /* DASHBOARD OVERRIDES */
      #dashboard-ui {
        display: none;
      }
      body.logged-in #dashboard-ui {
        display: contents;
      }
      body.logged-in #landing-page {
        display: none;
      }

      header {
        grid-column: 1 / span 3;
        background: #181a20;
        border-bottom: 1px solid var(--border);
        display: flex;
        align-items: center;
        padding: 0 20px;
        justify-content: space-between;
      }
      .logo-area {
        display: flex;
        align-items: center;
        gap: 20px;
        font-weight: 700;
      }
      #live-p-top {
        font-family: "JetBrains Mono";
        color: var(--up);
        font-size: 15px;
      }
      .toolbar {
        grid-row: 2 / span 2;
        background: #181a20;
        border-right: 1px solid var(--border);
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 12px 0;
        gap: 12px;
        position: relative;
      }
      .t-btn {
        width: 36px;
        height: 36px;
        background: transparent;
        border: none;
        color: #848e9c;
        cursor: pointer;
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        position: relative;
        transition: all 0.2s;
      }
      .t-btn:hover {
        background: #2b3139;
        color: #fff;
      }
      .t-btn.active {
        color: var(--gold);
        background: rgba(252, 213, 53, 0.1);
      }
      .t-group-menu {
        position: absolute;
        left: 48px;
        top: 0;
        background: #1e2329;
        border: 1px solid var(--border);
        border-radius: 8px;
        display: none;
        flex-direction: column;
        padding: 8px;
        gap: 4px;
        z-index: 20000;
        box-shadow: 10px 0 30px rgba(0, 0, 0, 0.5);
        min-width: 140px;
      }
      .t-group-menu.show {
        display: flex;
      }
      .t-sub-btn {
        padding: 8px 12px;
        color: #848e9c;
        cursor: pointer;
        border-radius: 4px;
        white-space: nowrap;
        font-size: 12px;
        transition: 0.2s;
        text-align: left;
        width: 100%;
        display: block;
      }
      .t-sub-btn:hover {
        background: #2b3139;
        color: #fff;
      }
      .t-sub-btn.active {
        color: var(--gold);
        background: rgba(252, 213, 53, 0.1);
      }
      main {
        position: relative;
        background: var(--bg);
        overflow: hidden;
        grid-column: 2;
        border-right: 1px solid var(--border);
      }
      .symbol-info-overlay {
        grid-column: 3;
        grid-row: 3;
        background: #181a20;
        padding: 20px;
        border-top: 1px solid var(--border);
        display: flex;
        flex-direction: column;
        justify-content: center;
        gap: 8px;
      }
      .overlay-sym {
        font-size: 22px;
        font-weight: 800;
        color: var(--gold);
      }
      .overlay-price {
        font-family: "JetBrains Mono";
        font-size: 24px;
        font-weight: 700;
      }
      .overlay-change {
        font-size: 16px;
        font-weight: 600;
      }
      #chart-canvas {
        width: 100%;
        height: 100%;
        cursor: crosshair;
      }
      .ohlc {
        position: absolute;
        top: 12px;
        left: 18px;
        display: flex;
        gap: 15px;
        font-family: "JetBrains Mono";
        color: #848e9c;
        pointer-events: none;
        z-index: 10;
        font-size: 12px;
      }
      .ohlc b {
        color: #fff;
      }
      .watchlist {
        grid-column: 3;
        background: #181a20;
        display: flex;
        flex-direction: column;
        overflow-y: auto;
      }
      .w-header {
        padding: 15px;
        border-bottom: 1px solid var(--border);
        font-weight: 700;
        color: #fff;
        font-size: 13px;
      }
      .w-item {
        padding: 14px 20px;
        display: flex;
        justify-content: space-between;
        border-bottom: 1px solid #2b3139;
        cursor: pointer;
      }
      .w-item:hover {
        background: #2b3139;
      }
      .w-item.active {
        border-left: 3px solid var(--gold);
        background: #1e2329;
      }
      .w-val {
        font-family: "JetBrains Mono";
        font-weight: bold;
      }
      footer {
        grid-column: 2;
        background: #181a20;
        border-top: 1px solid var(--border);
        display: grid;
        grid-template-columns: 350px 1fr 1fr;
      }
      .trade-panel {
        padding: 20px;
        display: flex;
        flex-direction: column;
        gap: 15px;
        border-right: 1px solid var(--border);
      }
      .order-manager,
      .history-manager {
        display: flex;
        flex-direction: column;
        overflow: hidden;
        border-right: 1px solid var(--border);
      }
      .history-manager {
        border-right: none;
      }
      .om-header {
        padding: 10px 15px;
        background: #1e2329;
        border-bottom: 1px solid var(--border);
        font-weight: 700;
        font-size: 10px;
        color: #848e9c;
        display: flex;
        justify-content: space-between;
      }
      .history-row {
        display: flex;
        align-items: center;
        padding: 8px 15px;
        border-bottom: 1px solid #2b3139;
        font-family: "JetBrains Mono";
        font-size: 10px;
        opacity: 0.8;
      }
      .history-row span {
        flex: 1;
      }
      .h-win {
        color: var(--up);
      }
      .h-loss {
        color: var(--down);
      }
      .order-row {
        display: flex;
        align-items: center;
        padding: 10px 15px;
        border-bottom: 1px solid #2b3139;
        font-family: "JetBrains Mono";
        font-size: 10px;
      }
      .order-row span {
        flex: 1;
      }
      .o-side-long {
        color: var(--up);
        font-weight: bold;
      }
      .o-side-short {
        color: var(--down);
        font-weight: bold;
      }
      .btn-close-order {
        background: #474d57;
        color: #fff;
        border: none;
        padding: 4px 8px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 9px;
      }
      .input-row {
        display: flex;
        gap: 15px;
      }
      .input-g {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 6px;
      }
      .input-g label {
        color: #848e9c;
        font-size: 10px;
        text-transform: uppercase;
        font-weight: 700;
      }
      .f-in {
        background: #2b3139;
        border: 1px solid transparent;
        color: #fff;
        padding: 10px;
        border-radius: 6px;
        font-weight: bold;
        font-family: "JetBrains Mono";
        outline: none;
      }
      .f-in:focus {
        border-color: var(--gold);
      }
      .trade-btns {
        display: flex;
        gap: 12px;
      }
      .btn-trade {
        flex: 1;
        padding: 14px;
        border: none;
        border-radius: 6px;
        font-weight: 800;
        cursor: pointer;
        color: #fff;
        font-size: 13px;
      }
      .b-long {
        background: var(--up);
      }
      .b-short {
        background: var(--down);
      }
      #toast {
        position: fixed;
        bottom: 200px;
        left: 50%;
        transform: translateX(-50%);
        background: #1e2329;
        border: 1px solid var(--gold);
        color: var(--gold);
        padding: 14px 40px;
        border-radius: 8px;
        display: none;
        z-index: 11000;
        font-weight: 800;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
      }
    </style>
  </head>
  <body>
    <div id="landing-page">
      <header class="lp-header">
        <div class="lp-logo">
          <img src="·∫£nh.jpg" alt="Logo" style="height: 32px" />
          LynxView
        </div>
        <nav class="lp-nav">
          <a href="#">Charts</a>
          <a href="#">Markets</a>
          <a href="#">Screeners</a>
          <a href="#" onclick="showEula()">Eula</a>
          <a href="#" onclick="showCreator()">Creator</a>
        </nav>
        <div class="lp-auth-btns">
          <button class="lp-btn lp-btn-outline" onclick="Auth.show('l')">
            Log In
          </button>
          <button class="lp-btn lp-btn-gold" onclick="Auth.show('r')">
            Sign Up
          </button>
        </div>
      </header>

      <section class="hero">
        <h1>Master the Markets<br />with Precision</h1>
        <p>
          The world's most advanced analytical platform for traders and
          investors. Real-time data, professional tools, and cloud
          synchronization.
        </p>
        <button
          class="lp-btn lp-btn-gold"
          style="font-size: 18px; padding: 18px 40px"
          onclick="Auth.show('r')"
        >
          Start Free Trial
        </button>

        <div class="hero-stats">
          <div class="stat-item">
            <h3>5M+</h3>
            <p>Active Users</p>
          </div>
          <div class="stat-item">
            <h3>100+</h3>
            <p>Exchanges</p>
          </div>
          <div class="stat-item">
            <h3>0.5ms</h3>
            <p>Data Latency</p>
          </div>
        </div>
      </section>

      <section class="features">
        <div class="feat-card">
          <div class="feat-icon">üìä</div>
          <h4>Advanced Charting</h4>
          <p>
            Over 100 indicators and professional drawing tools including
            Fibonacci, Arcs, and custom PnL trackers.
          </p>
        </div>
        <div class="feat-card">
          <div class="feat-icon">‚ö°</div>
          <h4>Real-time Execution</h4>
          <p>
            Direct integration with major exchanges for millisecond execution
            and zero-lag market data.
          </p>
        </div>
        <div class="feat-card">
          <div class="feat-icon">‚òÅÔ∏è</div>
          <h4>Smart Cloud Sync</h4>
          <p>
            Your analysis, drawings, and open positions are synced across all
            your devices automatically.
          </p>
        </div>
      </section>
    </div>

    <div id="auth-modal">
      <div class="auth-container">
        <span class="close-modal" onclick="Auth.hide()">&times;</span>
        <div class="auth-branding">
          <img src="·∫£nh.jpg" alt="LynxView Branding" />
          <h2>LynxView</h2>
          <p>
            H·ªá th·ªëng ph√¢n t√≠ch k·ªπ thu·∫≠t v√† giao d·ªãch chuy√™n nghi·ªáp d√†nh cho m·ªçi
            ng∆∞·ªùi.
          </p>
        </div>
        <div class="auth-box">
          <h1>Welcome back</h1>
          <p>Access your professional trading suite</p>
          <div class="auth-tab">
            <div id="tab-l" class="tab active" onclick="Auth.set('l')">
              Log In
            </div>
            <div id="tab-r" class="tab" onclick="Auth.set('r')">Sign Up</div>
          </div>
          <div class="auth-input-wrap">
            <label>Operator ID</label>
            <input
              type="text"
              id="u-name"
              class="auth-input"
              placeholder="e.g. trader_01"
            />
          </div>
          <div class="auth-input-wrap">
            <label>Security Key</label>
            <input
              type="password"
              id="u-pass"
              class="auth-input"
              placeholder="********"
            />
          </div>
          <button class="auth-btn" onclick="Auth.submit()">
            Access Terminal
          </button>
        </div>
      </div>
    </div>

    <div
      id="creator-modal"
      style="
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.8);
        z-index: 11000;
        display: none;
        align-items: center;
        justify-content: center;
      "
    >
      <div class="auth-box" style="text-align: center">
        <span
          class="close-modal"
          onclick="document.getElementById('creator-modal').style.display='none'"
          >&times;</span
        >
        <div style="font-size: 50px; margin-bottom: 20px">üë§</div>
        <p style="font-size: 18px; color: #fff; margin-bottom: 5px">
          H·ªì Nh·∫≠t Kh·ªüi
        </p>
        <p style="color: #848e9c">Vi·ªát Nam | 12 tu·ªïi</p>
        <div
          style="
            margin-top: 30px;
            padding: 20px;
            background: rgba(252, 213, 53, 0.05);
            border-radius: 12px;
            border: 1px dashed var(--gold);
          "
        >
          <p style="color: var(--gold); font-weight: 600">
            "ƒêam m√™ l·∫≠p tr√¨nh v√† t√†i ch√≠nh"
          </p>
        </div>
      </div>
    </div>

    <div id="dashboard-ui">
      <div id="toast">NOTIFICATION</div>
      <header>
        <img
          src="·∫£nh.jpg"
          alt="Logo"
          style="height: 40px; margin: 10px 20px 10px -20px"
        />
        <div class="logo-area">
          <span id="active-pair" style="font-size: 16px; color: var(--gold)"
            >BTCUSDT</span
          >
          <span id="live-p-top">...</span>
        </div>
        <div style="display: flex; gap: 25px; align-items: center">
          <div
            id="u-bal"
            style="
              color: var(--gold);
              font-weight: 800;
              font-size: 16px;
              background: rgba(252, 213, 53, 0.1);
              padding: 6px 15px;
              border-radius: 8px;
            "
          >
            $3,000.00
          </div>
          <div
            style="cursor: pointer; opacity: 0.6; font-weight: bold"
            onclick="location.reload()"
          >
            LOGOUT
          </div>
        </div>
      </header>
      <nav class="toolbar">
        <div
          class="t-btn"
          id="m-move"
          onclick="Chart.setMode('move', this, event)"
        >
          üñ±Ô∏è
        </div>
        <div class="t-btn" onclick="Chart.toggleMenu(event, this)">
          üìè
          <div class="t-group-menu">
            <div
              class="t-sub-btn"
              id="m-line"
              onclick="Chart.setMode('line', this, event)"
            >
              Trend Line
            </div>
            <div
              class="t-sub-btn"
              id="m-info"
              onclick="Chart.setMode('info', this, event)"
            >
              Info Line
            </div>
            <div
              class="t-sub-btn"
              id="m-arrow"
              onclick="Chart.setMode('arrow', this, event)"
            >
              Arrow
            </div>
            <div
              class="t-sub-btn"
              id="m-ray"
              onclick="Chart.setMode('ray', this, event)"
            >
              Ray
            </div>
            <div
              class="t-sub-btn"
              id="m-extended"
              onclick="Chart.setMode('extended', this, event)"
            >
              Extended
            </div>
            <div
              class="t-sub-btn"
              id="m-hline"
              onclick="Chart.setMode('hline', this, event)"
            >
              Horizontal
            </div>
            <div
              class="t-sub-btn"
              id="m-vline"
              onclick="Chart.setMode('vline', this, event)"
            >
              Vertical
            </div>
          </div>
        </div>
        <div class="t-btn" onclick="Chart.toggleMenu(event, this)">
          üìê
          <div class="t-group-menu">
            <div
              class="t-sub-btn"
              id="m-fibo"
              onclick="Chart.setMode('fibo', this, event)"
            >
              Retracement
            </div>
            <div
              class="t-sub-btn"
              id="m-f_ext"
              onclick="Chart.setMode('f_ext', this, event)"
            >
              Extension
            </div>
            <div
              class="t-sub-btn"
              id="m-f_fan"
              onclick="Chart.setMode('f_fan', this, event)"
            >
              Fib Fan
            </div>
            <div
              class="t-sub-btn"
              id="m-f_time"
              onclick="Chart.setMode('f_time', this, event)"
            >
              Time Zones
            </div>
            <div
              class="t-sub-btn"
              id="m-f_circles"
              onclick="Chart.setMode('f_circles', this, event)"
            >
              Fib Circles
            </div>
            <div
              class="t-sub-btn"
              id="m-f_arc"
              onclick="Chart.setMode('f_arc', this, event)"
            >
              Fib Arc
            </div>
            <div
              class="t-sub-btn"
              id="m-f_chan"
              onclick="Chart.setMode('f_chan', this, event)"
            >
              Channel
            </div>
          </div>
        </div>
        <div class="t-btn" onclick="Chart.toggleMenu(event, this)">
          üñåÔ∏è
          <div class="t-group-menu">
            <div
              class="t-sub-btn"
              id="m-brush"
              onclick="Chart.setMode('brush', this, event)"
            >
              Brush
            </div>
            <div
              class="t-sub-btn"
              id="m-rect"
              onclick="Chart.setMode('rect', this, event)"
            >
              Rectangle
            </div>
            <div
              class="t-sub-btn"
              id="m-circle"
              onclick="Chart.setMode('circle', this, event)"
            >
              Circle
            </div>
            <div
              class="t-sub-btn"
              id="m-triangle"
              onclick="Chart.setMode('triangle', this, event)"
            >
              Triangle
            </div>
            <div
              class="t-sub-btn"
              id="m-polyline"
              onclick="Chart.setMode('polyline', this, event)"
            >
              Polyline
            </div>
            <div
              class="t-sub-btn"
              id="m-arc"
              onclick="Chart.setMode('arc', this, event)"
            >
              Arc
            </div>
          </div>
        </div>
        <div class="t-btn" onclick="Chart.toggleMenu(event, this)">
          üåä
          <div class="t-group-menu">
            <div
              class="t-sub-btn"
              id="m-e_imp"
              onclick="Chart.setMode('e_imp', this, event)"
            >
              Elliott Impulse
            </div>
            <div
              class="t-sub-btn"
              id="m-e_cor"
              onclick="Chart.setMode('e_cor', this, event)"
            >
              Elliott Corrective
            </div>
            <div
              class="t-sub-btn"
              id="m-e_tri"
              onclick="Chart.setMode('e_tri', this, event)"
            >
              Elliott Triangle
            </div>
            <div
              class="t-sub-btn"
              id="m-head"
              onclick="Chart.setMode('head', this, event)"
            >
              Head & Shoulders
            </div>
            <div
              class="t-sub-btn"
              id="m-wave"
              onclick="Chart.setMode('wave', this, event)"
            >
              Wave
            </div>
          </div>
        </div>

        <div
          class="t-btn"
          id="m-eraser"
          onclick="Chart.setMode('eraser', this, event)"
        >
          üßπ
        </div>
        <div
          class="t-btn"
          id="btn-toggle-markers"
          onclick="Chart.toggleMarkers()"
          title="·∫®n/Hi·ªán d·∫•u mua b√°n"
          style="color: var(--gold)"
        >
          üëÅÔ∏è
        </div>
        <div
          class="t-btn"
          id="btn-toggle-snap"
          onclick="Chart.toggleSnap()"
          title="B·∫≠t/T·∫Øt h√≠t n·∫øn"
          style="color: var(--gold)"
        >
          üß≤
        </div>
        <div style="flex: 1"></div>
        <button
          class="t-btn"
          style="color: var(--down)"
          onclick="Chart.clearDraws()"
        >
          üóë
        </button>
      </nav>
      <main id="chart-container">
        <div id="market-status" onclick="Trade.toggleMarket()">
          <div id="m-dot" class="dot online"></div>
          <span id="m-txt">LIVE</span>
        </div>
        <div class="ohlc" id="ohlc-box">
          O<b>0.00</b> H<b>0.00</b> L<b>0.00</b> C<b>0.00</b>
          <span style="opacity: 0.5; margin-left: 10px">VOL: 0.00</span>
          <span style="opacity: 0.5; margin-left: 10px">OPEN: 0.00</span>
          <span style="opacity: 0.5; margin-left: 10px">CLOSE: 0.00</span>
          <span style="opacity: 0.5; margin-left: 10px">HIGH: 0.00</span>
          <span style="opacity: 0.5; margin-left: 10px">LOW: 0.00</span>
          <span style="opacity: 0.5; margin-left: 10px">CHANGE: 0.00%</span>
          <span style="opacity: 0.5; margin-left: 10px">CHANGE: 0.00</span>
          <span style="opacity: 0.5; margin-left: 10px">TIME: 00:00:00</span>
          <span style="opacity: 0.5; margin-left: 10px">DATE: 00/00/0000</span>
          <span style="opacity: 0.5; margin-left: 10px"
            >TIMESTAMP: 0000000000</span
          >
        </div>
        <canvas id="chart-canvas"></canvas>
      </main>
      <aside class="watchlist">
        <div class="w-header">Watchlist</div>
        <div id="w-list"></div>
      </aside>
      <div class="symbol-info-overlay">
        <div class="overlay-sym" id="ov-sym">BTCUSDT</div>
        <div class="overlay-price" id="ov-price">0.00</div>
        <div class="overlay-change" id="ov-change">0.00 (0.00%)</div>
      </div>
      <footer>
        <div class="trade-panel">
          <div class="input-row">
            <div class="input-g">
              <label>Investment</label>
              <input type="number" id="tr-amt" class="f-in" value="1000" />
            </div>
            <div class="input-g">
              <label>Leverage</label>
              <input type="number" id="tr-lev" class="f-in" value="50" />
            </div>
          </div>
          <div class="trade-btns">
            <button
              id="btn-buy"
              class="btn-trade b-long"
              onclick="Trade.exec('LONG')"
            >
              BUY
            </button>
            <button
              id="btn-sell"
              class="btn-trade b-short"
              onclick="Trade.exec('SHORT')"
            >
              SELL
            </button>
          </div>
        </div>
        <div class="order-manager">
          <div class="om-header">
            <span>OPEN POSITIONS</span>
            <span id="active-orders-count">0</span>
          </div>
          <div id="order-list"></div>
        </div>
        <div class="history-manager">
          <div class="om-header">
            <span>TRADE HISTORY</span>
          </div>
          <div id="history-list" style="overflow-y: auto"></div>
        </div>
      </footer>
    </div>

    <script>
      function showEula() {
        alert(
          "ƒêi·ªÅu kho·∫£n s·ª≠ d·ª•ng: B·∫°n ph·∫£i ƒë·ªìng √Ω v·ªõi ƒëi·ªÅu kho·∫£n s·ª≠ d·ª•ng c·ªßa ch√∫ng t√¥i ƒë·ªÉ s·ª≠ d·ª•ng d·ªãch v·ª• n√†y.",
        );
        alert(
          "ƒê√¢y ch·ªâ l√† tr√≤ ch∆°i v√† kh√¥ng c√≥ t√≠nh th·ª±c t·∫ø vui l√≤ng ƒë·ª´ng qua nghi·ªán m√† ƒë√°nh m·∫•t t·∫•t c·∫£ CH√öC B·∫†N CH∆†I VUI V·∫∫ V√Ä TH√ÄNH C√îNG.",
        );
        alert("B·∫°n ƒë√£ ƒë·ªìng √Ω v·ªõi ƒëi·ªÅu kho·∫£n s·ª≠ d·ª•ng c·ªßa ch√∫ng t√¥i.");
      }
      function showCreator() {
        document.getElementById("creator-modal").style.display = "flex";
      }
      const Auth = {
        mode: "l",
        show(m) {
          this.set(m);
          document.getElementById("auth-modal").style.display = "flex";
        },
        hide() {
          document.getElementById("auth-modal").style.display = "none";
        },
        set(m) {
          this.mode = m;
          document.getElementById("tab-l").className =
            m === "l" ? "tab active" : "tab";
          document.getElementById("tab-r").className =
            m === "r" ? "tab active" : "tab";
        },
        async submit() {
          const u = document.getElementById("u-name").value.trim();
          const p = document.getElementById("u-pass").value.trim();
          if (!u) return;
          try {
            const res = await fetch(`/api/load/${encodeURIComponent(u)}`);
            if (this.mode === "r") {
              if (res.ok) return alert("Operator exists");
              System.u = u;
              System.d = {
                bal: 3000,
                pass: p,
                draws: [],
                orders: [],
                history: [],
              };
              await Cloud.sync();
            } else {
              if (!res.ok) return alert("Operator not found");
              const data = (await res.json()).data;
              if (data.pass !== p) return alert("Security key mismatch");
              System.u = u;
              System.d = { ...data, history: data.history || [] };
            }
            document.body.classList.add("logged-in");
            this.hide();
            Chart.init();
          } catch (e) {
            console.error("Auth error:", e);
            alert("Connection error. Please try again.");
          }
        },
      };

      const Cloud = {
        async sync() {
          if (!System.u) return;
          await fetch("/api/save", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              username: System.u,
              data: {
                ...System.d,
                draws: Chart.draws,
                orders: Trade.orders,
                history: Trade.history,
              },
            }),
          });
        },
      };

      const System = { u: "", d: null };

      const Chart = {
        canvas: null,
        ctx: null,
        price: 0,
        candles: [],
        mode: "move",
        offX: 0,
        offY: 0,
        zoom: 10,
        draws: [],
        activeD: null,
        selectedNode: null,
        draggedDrawing: null,
        isDrag: false,
        lx: 0,
        ly: 0,
        symbol: "BTCUSDT",
        lastCandleTime: 0,
        candleInterval: 60000,
        showMarkers: true,
        snapToCandle: true,
        toggleMarkers() {
          this.showMarkers = !this.showMarkers;
          const btn = document.getElementById("btn-toggle-markers");
          if (btn)
            btn.style.color = this.showMarkers ? "var(--gold)" : "#848e9c";
          this.render();
        },
        toggleSnap() {
          this.snapToCandle = !this.snapToCandle;
          const btn = document.getElementById("btn-toggle-snap");
          if (btn)
            btn.style.color = this.snapToCandle ? "var(--gold)" : "#848e9c";
        },
        async init() {
          this.canvas = document.getElementById("chart-canvas");
          this.ctx = this.canvas.getContext("2d");
          this.resize();
          window.onresize = () => this.resize();
          this.loadWatchlist();
          await this.loadCandles();
          this.connectWS();
          this.events();
          if (System.d) {
            this.draws = System.d.draws || [];
            Trade.orders = System.d.orders || [];
            Trade.history = System.d.history || [];
            Trade.renderOrders();
            Trade.renderHistory();
          }
          this.startPoll();
        },
        loadWatchlist() {
          const pairs = [
            // --- CRYPTO (Binance API) ---
            { s: "BTCUSDT", p: "...", c: "up" },
            { s: "ETHUSDT", p: "...", c: "up" },
            { s: "SOLUSDT", p: "...", c: "up" },
            { s: "BNBUSDT", p: "...", c: "down" },
            { s: "ADAUSDT", p: "...", c: "up" },
            { s: "XRPUSDT", p: "...", c: "up" },
            { s: "DOTUSDT", p: "...", c: "down" },
            { s: "LINKUSDT", p: "...", c: "up" },

            // --- COMMODITIES & INDICES (Mock) ---
            { s: "GOLD", p: "2654.20", c: "up", mock: true },
            { s: "SILVER", p: "31.15", c: "up", mock: true },
            { s: "OIL_WTI", p: "72.45", c: "down", mock: true },
            { s: "US30", p: "39250", c: "up", mock: true },
            { s: "NAS100", p: "18210", c: "up", mock: true },
            { s: "SPX500", p: "5320", c: "up", mock: true },
            { s: "VIX", p: "18.2", c: "down", mock: true },
            { s: "VCB", p: "12.5", c: "up", mock: true },
            { s: "FPT", p: "12.5", c: "up", mock: true },

            // --- FOREX (Mock) ---
            { s: "EURUSD", p: "1.0852", c: "up", mock: true },
            { s: "GBPUSD", p: "1.2640", c: "down", mock: true },
            { s: "USDJPY", p: "151.20", c: "up", mock: true },
            { s: "AUDUSD", p: "0.6540", c: "down", mock: true },

            // --- TECH STOCKS (Mock) ---
            { s: "TSLA", p: "352.56", c: "down", mock: true },
            { s: "AAPL", p: "228.12", c: "up", mock: true },
            { s: "NVDA", p: "125.45", c: "up", mock: true },
            { s: "AMD", p: "152.30", c: "down", mock: true },
            { s: "MSFT", p: "420.75", c: "up", mock: true },
            { s: "GOOGL", p: "185.60", c: "up", mock: true },
            { s: "META", p: "520.10", c: "down", mock: true },
            { s: "AMZN", p: "198.40", c: "up", mock: true },
            { s: "NFLX", p: "650.25", c: "up", mock: true },
            { s: "DIS", p: "120.80", c: "down", mock: true },
            { s: "INTC", p: "35.60", c: "up", mock: true },
            { s: "PYPL", p: "220.50", c: "up", mock: true },
            { s: "SQ", p: "180.30", c: "down", mock: true },
            { s: "UBER", p: "55.20", c: "up", mock: true },
            { s: "LYFT", p: "45.80", c: "down", mock: true },
            { s: "SPOT", p: "32.10", c: "up", mock: true },
            { s: "ROKU", p: "85.60", c: "up", mock: true },
            { s: "ZM", p: "150.20", c: "down", mock: true },
            { s: "SHOP", p: "2100.50", c: "up", mock: true },
            { s: "CRWD", p: "85.30", c: "up", mock: true },
            { s: "SNOW", p: "120.40", c: "down", mock: true },
            { s: "DDOG", p: "145.60", c: "up", mock: true },
            { s: "OKTA", p: "220.80", c: "up", mock: true },
            { s: "TEAM", p: "180.30", c: "down", mock: true },
            { s: "ZS", p: "150.20", c: "up", mock: true },
            { s: "ADBE", p: "650.20", c: "down", mock: true },
            { s: "CRM", p: "280.40", c: "up", mock: true },
            { s: "NOW", p: "520.10", c: "up", mock: true },
            { s: "PLTR", p: "25.40", c: "up", mock: true },
            { s: "COIN", p: "210.15", c: "down", mock: true },
            { s: "MSTR", p: "1450.80", c: "up", mock: true },
            { s: "BABA", p: "75.30", c: "down", mock: true },
            { s: "NIO", p: "5.20", c: "down", mock: true },
            { s: "V", p: "275.40", c: "up", mock: true },
            { s: "MA", p: "450.10", c: "up", mock: true },
            { s: "JPM", p: "195.30", c: "up", mock: true },
            { s: "BAC", p: "38.20", c: "down", mock: true },
            { s: "WFC", p: "45.60", c: "up", mock: true },
          ];
          const list = document.getElementById("w-list");
          list.innerHTML = pairs
            .map(
              (p) => `
            <div class="w-item ${p.s === this.symbol ? "active" : ""}" onclick="Chart.changePair('${p.s}')">
              <span class="w-sym">${p.s}</span>
              <span class="w-val" id="val-${p.s}" style="color:var(--${p.c})">${p.p}</span>
            </div>
          `,
            )
            .join("");
        },
        changePair(s) {
          // 1. Ki·ªÉm tra xem c√≥ l·ªánh n√†o ƒëang m·ªü hay kh√¥ng
          if (Trade.orders && Trade.orders.length > 0) {
            // N·∫øu c√≥ √≠t nh·∫•t 1 l·ªánh, hi·ªán c·∫£nh b√°o v√† tho√°t h√†m (kh√¥ng cho chuy·ªÉn s√†n)
            alert(
              `‚ö†Ô∏è C·∫¢NH B√ÅO: KH√îNG TH·ªÇ CHUY·ªÇN S√ÄN!\n\n` +
                `B·∫°n ƒëang c√≥ ${Trade.orders.length} l·ªánh ƒëang m·ªü tr√™n s√†n ${this.symbol}.\n` +
                `Vui l√≤ng ƒë√≥ng t·∫•t c·∫£ l·ªánh hi·ªán t·∫°i tr∆∞·ªõc khi chuy·ªÉn sang ${s}!`,
            );
            return; // D·ª´ng t·∫°i ƒë√¢y, kh√¥ng th·ª±c hi·ªán c√°c d√≤ng code b√™n d∆∞·ªõi
          }

          // 2. N·∫øu kh√¥ng c√≥ l·ªánh, th·ª±c hi·ªán chuy·ªÉn s√†n nh∆∞ b√¨nh th∆∞·ªùng
          this.symbol = s;
          document.getElementById("active-pair").innerText = s;
          this.loadWatchlist();
          this.loadCandles();
          this.connectWS();
        },
        async loadCandles() {
          if (this.symbol.includes("USDT")) {
            const res = await fetch(
              `https://api.binance.com/api/v3/klines?symbol=${this.symbol}&interval=1m&limit=1000`,
            ).then((r) => r.json());
            this.candles = res.map((k) => ({
              o: +k[1],
              h: +k[2],
              l: +k[3],
              c: +k[4],
            }));
          } else {
            const basePrice = this.getMockBasePrice(this.symbol);
            this.candles = [];
            let lastC = basePrice;
            for (let i = 0; i < 1000; i++) {
              const o = lastC;
              const vol = basePrice * 0.002;
              const c = o + (Math.random() - 0.5) * vol;
              const h = Math.max(o, c) + Math.random() * (vol * 0.5);
              const l = Math.min(o, c) - Math.random() * (vol * 0.5);
              this.candles.push({ o, h, l, c });
              lastC = c;
            }
          }
          this.lastCandleTime = Math.floor(Date.now() / 60000) * 60000;
        },
        getMockBasePrice(s) {
          const prices = { GOLD: 2654.2, TSLA: 352.56, AAPL: 228.12 };
          return prices[s] || 100;
        },
        connectWS() {
          if (this.ws) this.ws.close();
          if (this.pollInterval) clearInterval(this.pollInterval);
          if (this.symbol.includes("USDT")) {
            const sym = this.symbol.toLowerCase();
            this.ws = new WebSocket(
              `wss://stream.binance.com:9443/ws/${sym}@aggTrade`,
            );
            this.ws.onmessage = (e) =>
              this.updatePrice(parseFloat(JSON.parse(e.data).p));
          } else {
            const basePrice = this.getMockBasePrice(this.symbol);
            this.price = basePrice;
            this.pollInterval = setInterval(() => {
              const volatility = basePrice * 0.0005;
              const newPrice = this.price + (Math.random() - 0.5) * volatility;
              this.updatePrice(newPrice);
            }, 1000);
          }
        },
        updatePrice(p) {
          const oldPrice = this.price;
          this.price = p;

          const change = p - oldPrice;
          const changePercent = oldPrice !== 0 ? (change / oldPrice) * 100 : 0;
          const colorClass = change >= 0 ? "up" : "down";
          const colorHex = change >= 0 ? "var(--up)" : "var(--down)";

          const ovSym = document.getElementById("ov-sym");
          const ovPrice = document.getElementById("ov-price");
          const ovChange = document.getElementById("ov-change");

          if (ovSym) ovSym.innerText = this.symbol;
          if (ovPrice) {
            ovPrice.innerText = p.toLocaleString(undefined, {
              minimumFractionDigits: 2,
            });
            ovPrice.style.color = colorHex;
          }
          if (ovChange) {
            ovChange.innerText = `${change >= 0 ? "+" : ""}${change.toFixed(2)} (${changePercent.toFixed(2)}%)`;
            ovChange.style.color = colorHex;
          }

          const valEl = document.getElementById(`val-${this.symbol}`);
          if (valEl)
            valEl.innerText = p.toLocaleString(undefined, {
              minimumFractionDigits: 2,
            });
          const now = Date.now();
          const currentMin =
            Math.floor(now / this.candleInterval) * this.candleInterval;
          if (currentMin > this.lastCandleTime) {
            this.candles.push({ o: p, h: p, l: p, c: p });
            this.lastCandleTime = currentMin;
            if (this.candles.length > 1000) this.candles.shift();
          } else {
            const last = this.candles[this.candles.length - 1];
            last.c = p;
            if (p > last.h) last.h = p;
            if (p < last.l) last.l = p;
          }
          document.getElementById("live-p-top").innerText = p.toLocaleString(
            undefined,
            { minimumFractionDigits: 2 },
          );
          document.getElementById("u-bal").innerText =
            `$${System.d.bal.toLocaleString(undefined, { minimumFractionDigits: 2 })}`;

          // Thanh l√Ω t·ª± ƒë·ªông n·∫øu l·ªó > 95%
          Trade.orders.forEach((o) => {
            const pnl =
              o.side === "LONG" ? this.price - o.entry : o.entry - this.price;
            const profit = (pnl / o.entry) * o.amt * o.lev;
            if (profit <= -o.amt * 0.95) {
              Trade.closeOrder(o.id);
            }
          });

          this.render();
          Trade.renderOrders();
        },
        resize() {
          this.canvas.width = this.canvas.parentElement.clientWidth;
          this.canvas.height = this.canvas.parentElement.clientHeight;
          this.render();
        },
        setMode(m, btn, e) {
          if (e) e.stopPropagation();
          this.mode = m;
          document
            .querySelectorAll(".t-sub-btn, .t-btn")
            .forEach((b) => b.classList.remove("active"));

          if (btn) {
            btn.classList.add("active");
            const parentBtn = btn.closest(".t-btn");
            if (parentBtn) parentBtn.classList.add("active");
          } else {
            const el = document.getElementById(`m-${m}`);
            if (el) el.classList.add("active");
          }

          document
            .querySelectorAll(".t-group-menu")
            .forEach((m) => m.classList.remove("show"));
        },
        toggleMenu(e, btn) {
          e.stopPropagation();
          const menu = btn.querySelector(".t-group-menu");
          if (!menu) return;
          const isShow = menu.classList.contains("show");
          document
            .querySelectorAll(".t-group-menu")
            .forEach((m) => m.classList.remove("show"));
          if (!isShow) menu.classList.add("show");
        },
        clearDraws() {
          this.draws = [];
          this.render();
          Cloud.sync();
        },
        startPoll() {
          setInterval(async () => {
            if (!System.u || this.isDrag) return;
            try {
              const res = await fetch(
                `/api/load/${encodeURIComponent(System.u)}`,
              );
              if (res.ok) {
                const data = (await res.json()).data;
                System.d.bal = data.bal;
                if (JSON.stringify(data.draws) !== JSON.stringify(this.draws)) {
                  this.draws = data.draws || [];
                  this.render();
                }
              }
            } catch (e) {}
          }, 5000);
        },
        events() {
          this.canvas.onmousedown = (e) => {
            this.isDrag = true;
            this.lx = e.clientX;
            this.ly = e.clientY;
            const r = this.canvas.getBoundingClientRect();
            const mx = e.clientX - r.left,
              my = e.clientY - r.top;

            const relevantLocal = this.candles.slice(
              -Math.floor(this.canvas.width / this.zoom) - 50,
            );
            const maxL = Math.max(...relevantLocal.map((c) => c.h));
            const minL = Math.min(...relevantLocal.map((c) => c.l));
            const rngL = maxL - minL || 1;
            const midL = (maxL + minL) / 2;
            const scaleL = (this.canvas.height * 0.8) / rngL;

            const getCandleIdx = (mxCoord) =>
              this.candles.length -
              Math.floor((this.canvas.width - mxCoord + this.offX) / this.zoom);
            const getPriceValLocal = (yCoord) =>
              (this.canvas.height / 2 + this.offY - yCoord) / scaleL + midL;
            const getPriceYLocal = (v) =>
              this.canvas.height / 2 - (v - midL) * scaleL + this.offY;
            const getXLocal = (idx) =>
              this.canvas.width -
              (this.candles.length - idx) * this.zoom +
              this.offX;

            this.selectedNode = null;
            this.draggedDrawing = null;

            if (this.mode === "eraser") {
              const before = this.draws.length;
              this.draws = this.draws.filter((d) => {
                const sx1 = getXLocal(d.i1 || 0),
                  sy1 = getY(d.p1);
                if (Math.hypot(mx - sx1, my - sy1) < 20) return false;
                if (d.i2 !== undefined) {
                  const sx2 = getXLocal(d.i2),
                    sy2 = getY(d.p2);
                  if (Math.hypot(mx - sx2, my - sy2) < 20) return false;
                  const C = sx2 - sx1,
                    D = sy2 - sy1;
                  const dot = (mx - sx1) * C + (my - sy1) * D,
                    len_sq = C * C + D * D;
                  let param = len_sq != 0 ? dot / len_sq : -1;
                  let xx = param < 0 ? sx1 : param > 1 ? sx2 : sx1 + param * C;
                  let yy = param < 0 ? sy1 : param > 1 ? sy2 : sy1 + param * D;
                  if (Math.hypot(mx - xx, my - yy) < 15) return false;
                }
                if (
                  d.points &&
                  d.points.some(
                    (p) => Math.hypot(mx - getXLocal(p.i), my - getY(p.p)) < 15,
                  )
                )
                  return false;
                return true;
              });
              if (this.draws.length !== before) {
                Cloud.sync();
                this.render();
              }
              return;
            }

            const multiPointTools = [
              "wave",
              "polyline",
              "e_tri",
              "e_imp",
              "e_cor",
              "f_chan",
            ];
            if (multiPointTools.includes(this.mode)) {
              if (this.activeD && this.activeD.type === this.mode) {
                this.activeD.points.push({
                  i: getCandleIdx(mx),
                  p: getPriceValLocal(my),
                });
                this.render(mx, my);
                return;
              }
              this.activeD = {
                type: this.mode,
                points: [{ i: getCandleIdx(mx), p: getPriceValLocal(my) }],
              };
              // Add first point immediately for visual feedback
              this.activeD.points.push({
                i: getCandleIdx(mx),
                p: getPriceValLocal(my),
              });
              this.render(mx, my);
              return;
            }

            for (let d of this.draws) {
              const x1 = getXLocal(d.i1 || 0),
                y1 = getPriceYLocal(d.p1);
              if (Math.hypot(mx - x1, my - y1) < 15) {
                this.selectedNode = { d, p: "x1y1" };
                break;
              }
              if (d.i2 !== undefined) {
                const x2 = getXLocal(d.i2),
                  y2 = getPriceYLocal(d.p2);
                if (Math.hypot(mx - x2, my - y2) < 15) {
                  this.selectedNode = { d, p: "x2y2" };
                  break;
                }
                if (d.type === "arc" || d.type === "arc_inv") {
                  const midX = (x1 + x2) / 2,
                    midY = (y1 + y2) / 2,
                    dist = Math.hypot(x2 - x1, y2 - y1);
                  const cpY =
                    midY + dist * (d.depth || (d.type === "arc" ? 0.4 : -0.4));
                  if (Math.hypot(mx - midX, my - cpY) < 15) {
                    this.selectedNode = { d, p: "depth" };
                    break;
                  }
                }
              }
            }

            // N·∫øu kh√¥ng ch·ªçn n√∫t, ki·ªÉm tra xem c√≥ nh·∫•n v√†o ƒë∆∞·ªùng ƒë·ªÉ di chuy·ªÉn c·∫£ h√¨nh kh√¥ng
            if (!this.selectedNode && this.mode === "move") {
              for (let d of this.draws) {
                const sx1 = getXLocal(d.i1 || 0),
                  sy1 = getPriceYLocal(d.p1);
                if (d.i2 !== undefined) {
                  const sx2 = getXLocal(d.i2),
                    sy2 = getPriceYLocal(d.p2);
                  const C = sx2 - sx1,
                    D = sy2 - sy1;
                  const dot = (mx - sx1) * C + (my - sy1) * D,
                    len_sq = C * C + D * D;
                  let param = len_sq != 0 ? dot / len_sq : -1;
                  let xx = param < 0 ? sx1 : param > 1 ? sx2 : sx1 + param * C;
                  let yy = param < 0 ? sy1 : param > 1 ? sy2 : sy1 + param * D;
                  if (Math.hypot(mx - xx, my - yy) < 15) {
                    this.draggedDrawing = {
                      d,
                      startX: mx,
                      startY: my,
                      startI1: d.i1,
                      startP1: d.p1,
                      startI2: d.i2,
                      startP2: d.p2,
                    };
                    break;
                  }
                }
              }
            }

            if (this.selectedNode || this.draggedDrawing) return;

            if (this.mode !== "move") {
              const p = getPriceValLocal(my);
              this.activeD = {
                type: this.mode,
                i1: getCandleIdx(mx),
                p1: p,
                i2: getCandleIdx(mx),
                p2: p,
                depth: 0.4,
              };
            }
          };
          window.onmousemove = (e) => {
            const r = this.canvas.getBoundingClientRect();
            const mx = e.clientX - r.left,
              my = e.clientY - r.top;

            const relevantLocal = this.candles.slice(
              -Math.floor(this.canvas.width / this.zoom) - 50,
            );
            const maxL = Math.max(...relevantLocal.map((c) => c.h));
            const minL = Math.min(...relevantLocal.map((c) => c.l));
            const rngL = maxL - minL || 1;
            const midL = (maxL + minL) / 2;
            const scaleL = (this.canvas.height * 0.8) / rngL;

            const getCandleIdx = (mxCoord) =>
              this.candles.length -
              Math.floor((this.canvas.width - mxCoord + this.offX) / this.zoom);
            const getPriceValLocal = (yCoord) =>
              (this.canvas.height / 2 + this.offY - yCoord) / scaleL + midL;

            let finalPrice = getPriceValLocal(my);
            let finalIdx = getCandleIdx(mx);

            if (this.snapToCandle) {
              const candle = this.candles[finalIdx];
              if (candle) {
                const pO = Math.abs(finalPrice - candle.o);
                const pH = Math.abs(finalPrice - candle.h);
                const pL = Math.abs(finalPrice - candle.l);
                const pC = Math.abs(finalPrice - candle.c);
                const min = Math.min(pO, pH, pL, pC);
                if (min === pO) finalPrice = candle.o;
                else if (min === pH) finalPrice = candle.h;
                else if (min === pL) finalPrice = candle.l;
                else finalPrice = candle.c;
              }
            }

            this.mouseX = mx;
            this.mouseY = my;
            this.mousePrice = getPriceValLocal(my);

            if (!this.isDrag) {
              this.render(mx, my);
              return;
            }
            if (this.selectedNode) {
              const { d, p } = this.selectedNode;
              if (p === "x1y1") {
                d.i1 = finalIdx;
                d.p1 = finalPrice;
              } else if (p === "x2y2") {
                d.i2 = finalIdx;
                d.p2 = finalPrice;
              } else if (p === "depth") {
                const x1 = getXLocal(d.i1),
                  y1 = getPriceYLocal(d.p1);
                const x2 = getXLocal(d.i2),
                  y2 = getPriceYLocal(d.p2);
                const midY = (y1 + y2) / 2;
                const dist = Math.hypot(x2 - x1, y2 - y1) || 1;
                d.depth = (my - midY) / dist;
              }
              this.render(mx, my);
              return;
            }
            if (this.draggedDrawing) {
              const { d, startX, startY, startI1, startP1, startI2, startP2 } =
                this.draggedDrawing;
              const dx = mx - startX;
              const dy = my - startY;

              // T√≠nh to√°n ƒë·ªô l·ªách index v√† gi√°
              const di = Math.floor(dx / this.zoom);
              const dp = getPriceValLocal(startY) - getPriceValLocal(my); // Sai l·ªách gi√° d·ª±a tr√™n t·ªâ l·ªá scale

              d.i1 = startI1 + di;
              d.p1 = getPriceValLocal(getPriceYLocal(startP1) + dy);
              if (d.i2 !== undefined) {
                d.i2 = startI2 + di;
                d.p2 = getPriceValLocal(getPriceYLocal(startP2) + dy);
              }
              if (d.type === "brush" && d.points) {
                // Brush dragging logic if needed
              }
              this.render(mx, my);
              return;
            }
            if (!this.isDrag) {
              this.render(mx, my);
              return;
            }
            if (this.mode === "move") {
              this.offX += e.clientX - this.lx;
              this.offY += e.clientY - this.ly;
            } else if (this.mode === "brush") {
              if (!this.activeD.points) this.activeD.points = [];
              this.activeD.points.push({
                i: getCandleIdx(mx),
                p: getPriceValLocal(my),
              });
            } else if (this.activeD) {
              if (this.activeD.points) {
                const lastPoint =
                  this.activeD.points[this.activeD.points.length - 1];
                lastPoint.i = finalIdx;
                lastPoint.p = finalPrice;
              } else {
                this.activeD.i2 = finalIdx;
                this.activeD.p2 = finalPrice;
              }
            }
            this.lx = e.clientX;
            this.ly = e.clientY;
            this.mouseX = mx;
            this.mouseY = my;
            this.mousePrice = getPriceValLocal(my);
            this.render(mx, my);
          };
          window.onmouseup = (e) => {
            if (this.selectedNode || this.draggedDrawing) Cloud.sync();

            // For multi-point tools, we don't finish on mouseup, we keep adding points on click.
            // But we need to handle the case where a user might want to "finish" or if they are just clicking.
            const multiPointTools = [
              "wave",
              "polyline",
              "e_tri",
              "e_imp",
              "e_cor",
              "f_chan",
            ];
            if (this.activeD && !multiPointTools.includes(this.activeD.type)) {
              this.draws.push(this.activeD);
              Cloud.sync();
              this.activeD = null;
            } else if (
              this.activeD &&
              multiPointTools.includes(this.activeD.type)
            ) {
              // We keep it as activeD until some finishing condition (e.g. double click or specific point count)
              // For now, let's keep it active so points keep getting added.
              // To finish a wave/polyline, user can switch mode.
            }

            this.isDrag = false;
            this.selectedNode = null;
            this.draggedDrawing = null;
            this.render();
          };
          // Add a way to finish multi-point drawings (right click or double click)
          this.canvas.oncontextmenu = (e) => {
            e.preventDefault();
            if (this.activeD) {
              this.draws.push(this.activeD);
              Cloud.sync();
              this.activeD = null;
              this.render();
            }
          };
          this.canvas.onwheel = (e) => {
            e.preventDefault();
            this.zoom = Math.max(
              2,
              Math.min(150, this.zoom + (e.deltaY > 0 ? -1 : 1)),
            );
            this.render();
          };
        },
        render(mx, my) {
          const { ctx, canvas } = this;
          ctx.fillStyle = "#0b0e11";
          ctx.fillRect(0, 0, canvas.width, canvas.height);
          ctx.strokeStyle = "#1e222d";
          ctx.lineWidth = 0.5;
          for (let x = this.offX % 50; x < canvas.width; x += 50) {
            ctx.beginPath();
            ctx.moveTo(x, 0);
            ctx.lineTo(x, canvas.height);
            ctx.stroke();
          }
          for (let y = this.offY % 50; y < canvas.height; y += 50) {
            ctx.beginPath();
            ctx.moveTo(0, y);
            ctx.lineTo(canvas.width, y);
            ctx.stroke();
          }

          const relevant = this.candles.slice(
            -Math.floor(canvas.width / this.zoom) - 50,
          );
          const max = Math.max(...relevant.map((c) => c.h)),
            min = Math.min(...relevant.map((c) => c.l)),
            rng = max - min || 1;
          const mid = (max + min) / 2;
          const scale = (canvas.height * 0.8) / rng;
          const getY = (v) => canvas.height / 2 - (v - mid) * scale + this.offY;
          const getXLocal = (idx) =>
            canvas.width - (this.candles.length - idx) * this.zoom + this.offX;
          this.candles.forEach((c, i) => {
            const x =
              canvas.width - (this.candles.length - i) * this.zoom + this.offX;
            if (x < -50 || x > canvas.width + 50) return;
            const isUp = c.c >= c.o;
            ctx.fillStyle = ctx.strokeStyle = isUp ? "#0ecb81" : "#f6465d";
            const midX = x + this.zoom / 2;
            ctx.beginPath();
            ctx.moveTo(midX, getY(c.h));
            ctx.lineTo(midX, getY(c.l));
            ctx.stroke();
            const bodyW = Math.max(1, this.zoom * 0.8);
            ctx.fillRect(
              midX - bodyW / 2,
              Math.min(getY(c.o), getY(c.c)),
              bodyW,
              Math.max(1, Math.abs(getY(c.o) - getY(c.c))),
            );
          });
          this.draws.concat(this.activeD || []).forEach((d) => {
            ctx.strokeStyle = "#2962ff";
            ctx.lineWidth = 2;
            ctx.beginPath();
            const sx1 = getXLocal(d.i1 || 0),
              sy1 = getY(d.p1);
            const sx2 =
              d.type === "hline"
                ? canvas.width
                : d.type === "ray"
                  ? sx1 + (getXLocal(d.i2) - sx1) * 10
                  : getXLocal(d.i2);
            const sy2 =
              d.type === "vline"
                ? canvas.height
                : d.type === "ray"
                  ? sy1 + (getY(d.p2) - sy1) * 10
                  : getY(d.p2);

            if (
              d.type === "line" ||
              d.type === "meas" ||
              d.type === "hline" ||
              d.type === "vline" ||
              d.type === "ray"
            ) {
              ctx.moveTo(
                d.type === "hline" ? 0 : sx1,
                d.type === "vline" ? 0 : sy1,
              );
              ctx.lineTo(sx2, sy2);
              if (d.type === "arrow") {
                const angle = Math.atan2(sy2 - sy1, sx2 - sx1);
                ctx.lineTo(
                  sx2 - 10 * Math.cos(angle - Math.PI / 6),
                  sy2 - 10 * Math.sin(angle - Math.PI / 6),
                );
                ctx.moveTo(sx2, sy2);
                ctx.lineTo(
                  sx2 - 10 * Math.cos(angle + Math.PI / 6),
                  sy2 - 10 * Math.sin(angle + Math.PI / 6),
                );
              }
            } else if (d.type === "arrow") {
              ctx.moveTo(sx1, sy1);
              ctx.lineTo(sx2, sy2);
              const angle = Math.atan2(sy2 - sy1, sx2 - sx1);
              ctx.lineTo(
                sx2 - 12 * Math.cos(angle - Math.PI / 6),
                sy2 - 12 * Math.sin(angle - Math.PI / 6),
              );
              ctx.moveTo(sx2, sy2);
              ctx.lineTo(
                sx2 - 12 * Math.cos(angle + Math.PI / 6),
                sy2 - 12 * Math.sin(angle + Math.PI / 6),
              );
            } else if (d.type === "rect") {
              ctx.strokeRect(sx1, sy1, sx2 - sx1, sy2 - sy1);
            } else if (d.type === "circle") {
              const rx = Math.abs(sx2 - sx1) / 2;
              const ry = Math.abs(sy2 - sy1) / 2;
              const cx = (sx1 + sx2) / 2;
              const cy = (sy1 + sy2) / 2;
              ctx.beginPath();
              ctx.ellipse(cx, cy, rx, ry, 0, 0, Math.PI * 2);
              ctx.stroke();
            } else if (d.type === "brush" && d.points) {
              ctx.beginPath();
              d.points.forEach((p, i) => {
                const px = getXLocal(p.i),
                  py = getY(p.p);
                if (i === 0) ctx.moveTo(px, py);
                else ctx.lineTo(px, py);
              });
              ctx.stroke();
            } else if (d.type === "arc" || d.type === "arc_inv") {
              const mxH = (sx1 + sx2) / 2,
                dist = Math.hypot(sx2 - sx1, sy2 - sy1);
              const cpY =
                (sy1 + sy2) / 2 +
                dist * (d.depth || (d.type === "arc" ? 0.4 : -0.4));
              ctx.moveTo(sx1, sy1);
              ctx.quadraticCurveTo(mxH, cpY, sx2, sy2);
            } else if (
              d.type === "f_circles" &&
              d.points &&
              d.points.length >= 2
            ) {
              const r = Math.hypot(sx2 - sx1, sy2 - sy1);
              [0.236, 0.382, 0.5, 0.618, 0.786, 1].forEach((lvl) => {
                ctx.beginPath();
                ctx.arc(sx1, sy1, r * lvl, 0, Math.PI * 2);
                ctx.stroke();
              });
            } else if (d.type === "f_arc" && d.points && d.points.length >= 2) {
              const r = Math.hypot(sx2 - sx1, sy2 - sy1);
              const angle = Math.atan2(sy2 - sy1, sx2 - sx1);
              [0.236, 0.382, 0.5, 0.618, 0.786, 1].forEach((lvl) => {
                ctx.beginPath();
                ctx.arc(sx1, sy1, r * lvl, angle - 0.5, angle + 0.5);
                ctx.stroke();
              });
            } else if (d.type === "wave" && d.points && d.points.length >= 2) {
              ctx.beginPath();
              d.points.forEach((p, i) => {
                const px = getXLocal(p.i),
                  py = getY(p.p);
                if (i === 0) ctx.moveTo(px, py);
                else ctx.lineTo(px, py);
                ctx.save();
                ctx.fillStyle = "#fff";
                ctx.font = "bold 10px Arial";
                ctx.fillText(i.toString(), px + 5, py - 5);
                ctx.restore();
              });
              ctx.stroke();
            } else if (
              d.type === "f_chan" &&
              d.points &&
              d.points.length >= 2
            ) {
              const p1 = d.points[0],
                p2 = d.points[1],
                p3 = d.points[2] || p2;
              const x1 = getXLocal(p1.i),
                y1 = getY(p1.p);
              const x2 = getXLocal(p2.i),
                y2 = getY(p2.p);
              const x3 = getXLocal(p3.i),
                y3 = getY(p3.p);
              const offset = y3 - y1;
              ctx.beginPath();
              ctx.moveTo(x1, y1);
              ctx.lineTo(x2, y2);
              ctx.moveTo(x1, y1 + offset);
              ctx.lineTo(x2, y2 + offset);
              ctx.stroke();
              ctx.globalAlpha = 0.1;
              ctx.fillStyle = ctx.strokeStyle;
              ctx.beginPath();
              ctx.moveTo(x1, y1);
              ctx.lineTo(x2, y2);
              ctx.lineTo(x2, y2 + offset);
              ctx.lineTo(x1, y1 + offset);
              ctx.fill();
              ctx.globalAlpha = 1.0;
            } else if (d.type === "e_tri" && d.points && d.points.length >= 2) {
              ctx.beginPath();
              d.points.forEach((p, i) => {
                const px = getXLocal(p.i),
                  py = getY(p.p);
                if (i === 0) ctx.moveTo(px, py);
                else ctx.lineTo(px, py);
                ctx.save();
                ctx.fillStyle = "#fff";
                ctx.font = "bold 10px Arial";
                ctx.fillText(["A", "B", "C", "D", "E"][i] || i, px + 5, py - 5);
                ctx.restore();
              });
              if (d.points.length >= 3) ctx.closePath();
              ctx.stroke();
            } else if (d.type === "fibo") {
              const h = sy2 - sy1;
              const lvls = [
                { l: 0, c: "#848e9c" },
                { l: 0.236, c: "#f6465d" },
                { l: 0.382, c: "#ff9800" },
                { l: 0.5, c: "#0ecb81" },
                { l: 0.618, c: "#2196f3" },
                { l: 0.786, c: "#9c27b0" },
                { l: 1, c: "#848e9c" },
              ];
              lvls.forEach((lvl) => {
                const curY = sy1 + h * lvl.l;
                ctx.strokeStyle = lvl.c;
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.moveTo(0, curY);
                ctx.lineTo(canvas.width, curY);
                ctx.stroke();
                ctx.fillStyle = lvl.c;
                ctx.fillText(lvl.l.toString(), sx1 + 5, curY - 5);
              });
            } else if (d.type === "f_ext") {
              const h = sy2 - sy1;
              [0, 0.236, 0.382, 0.5, 0.618, 0.786, 1, 1.618, 2.618].forEach(
                (lvl) => {
                  const y = sy1 + h * lvl;
                  ctx.strokeStyle = "#848e9c";
                  ctx.beginPath();
                  ctx.moveTo(0, y);
                  ctx.lineTo(canvas.width, y);
                  ctx.stroke();
                  ctx.fillText(lvl.toString(), sx1 + 5, y - 5);
                },
              );
            } else if (d.type === "f_fan") {
              ctx.beginPath();
              [0.382, 0.5, 0.618, 0.786, 1].forEach((lvl) => {
                ctx.moveTo(sx1, sy1);
                ctx.lineTo(sx2, sy1 + (sy2 - sy1) * lvl);
              });
              ctx.stroke();
            } else if (d.type === "f_time") {
              for (let i = 0; i < 15; i++) {
                const x = sx1 + i * (sx2 - sx1);
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, canvas.height);
                ctx.stroke();
              }
            } else if (d.type === "e_imp") {
              const points = [
                { x: sx1, y: sy1 },
                { x: sx1 + (sx2 - sx1) * 0.25, y: sy1 + (sy2 - sy1) * 0.4 },
                { x: sx1 + (sx2 - sx1) * 0.5, y: sy1 + (sy2 - sy1) * 0.1 },
                { x: sx1 + (sx2 - sx1) * 0.75, y: sy1 + (sy2 - sy1) * 0.3 },
                { x: sx2, y: sy2 },
              ];
              ctx.beginPath();
              ctx.moveTo(sx1, sy1);
              points.forEach((p, i) => {
                ctx.lineTo(p.x, p.y);
                ctx.save();
                ctx.fillStyle = "#fff";
                ctx.font = "bold 10px Arial";
                ctx.fillText(i.toString(), p.x + 5, p.y - 5);
                ctx.restore();
              });
              ctx.stroke();
            } else if (d.type === "e_cor") {
              const points = [
                { x: sx1, y: sy1 },
                { x: sx1 + (sx2 - sx1) * 0.5, y: sy1 + (sy2 - sy1) * 0.4 },
                { x: sx2, y: sy2 },
              ];
              ctx.beginPath();
              ctx.moveTo(sx1, sy1);
              ["A", "B", "C"].forEach((l, i) => {
                if (points[i]) {
                  ctx.lineTo(points[i].x, points[i].y);
                  ctx.save();
                  ctx.fillStyle = "#fff";
                  ctx.font = "bold 10px Arial";
                  ctx.fillText(l, points[i].x + 5, points[i].y - 5);
                  ctx.restore();
                }
              });
              ctx.stroke();
            } else if (d.type === "info") {
              const dist = Math.hypot(sx2 - sx1, sy2 - sy1).toFixed(2);
              const angle = (
                (Math.atan2(sy2 - sy1, sx2 - sx1) * 180) /
                Math.PI
              ).toFixed(1);
              ctx.beginPath();
              ctx.moveTo(sx1, sy1);
              ctx.lineTo(sx2, sy2);
              ctx.stroke();
              ctx.fillText(
                `${dist}px, ${angle}¬∞`,
                (sx1 + sx2) / 2,
                (sy1 + sy2) / 2 - 10,
              );
            } else if (d.type === "extended") {
              const angle = Math.atan2(sy2 - sy1, sx2 - sx1);
              ctx.beginPath();
              ctx.moveTo(
                sx1 - 5000 * Math.cos(angle),
                sy1 - 5000 * Math.sin(angle),
              );
              ctx.lineTo(
                sx1 + 5000 * Math.cos(angle),
                sy1 + 5000 * Math.sin(angle),
              );
              ctx.stroke();
            } else if (d.type === "triangle") {
              ctx.beginPath();
              ctx.moveTo(sx1, sy1);
              ctx.lineTo(sx2, sy2);
              ctx.lineTo(sx1, sy2);
              ctx.closePath();
              ctx.stroke();
            } else if (d.type === "head") {
              const midX = (sx1 + sx2) / 2;
              ctx.beginPath();
              ctx.moveTo(sx1, sy2);
              ctx.lineTo(sx1 + (midX - sx1) * 0.5, sy1 + (sy2 - sy1) * 0.3); // Left shoulder
              ctx.lineTo(sx1 + (midX - sx1), sy2);
              ctx.lineTo(midX, sy1); // Head
              ctx.lineTo(sx2 - (sx2 - midX) * 0.5, sy2);
              ctx.lineTo(sx2 - (sx2 - midX) * 0.25, sy1 + (sy2 - sy1) * 0.3); // Right shoulder
              ctx.lineTo(sx2, sy2);
              ctx.stroke();
            } else if (d.type === "polyline" || d.type === "path") {
              ctx.beginPath();
              ctx.moveTo(sx1, sy1);
              ctx.lineTo(sx2, sy2);
              ctx.stroke();
            }

            ctx.stroke();
          });
          // DRAW TRADE MARKERS & PNL
          if (this.showMarkers) {
            Trade.orders.forEach((o) => {
              if (o.pair !== this.symbol) return;
              const x =
                canvas.width -
                (this.candles.length - o.entryIdx) * this.zoom +
                this.offX;
              if (x < 0 || x > canvas.width) return;
              const y = getY(o.entry);
              const isLong = o.side === "LONG";
              const pnl = isLong ? this.price - o.entry : o.entry - this.price;
              const pnlPercent = (pnl / o.entry) * 100 * o.lev;

              ctx.setLineDash([5, 5]);
              ctx.strokeStyle = isLong
                ? "rgba(14, 203, 129, 0.3)"
                : "rgba(246, 70, 93, 0.3)";
              ctx.beginPath();
              ctx.moveTo(0, y);
              ctx.lineTo(canvas.width, y);
              ctx.stroke();
              ctx.setLineDash([]);

              ctx.fillStyle = pnlPercent >= 0 ? "#0ecb81" : "#f6465d";
              ctx.font = "bold 10px JetBrains Mono";
              const pnlText = `${pnlPercent >= 0 ? "+" : ""}${pnlPercent.toFixed(2)}%`;
              ctx.fillText(pnlText, canvas.width - 60, y - 5);
            });

            Trade.orders.concat(Trade.history).forEach((o) => {
              if (o.pair !== this.symbol) return;
              const x =
                canvas.width -
                (this.candles.length - o.entryIdx) * this.zoom +
                this.offX;
              if (x < 0 || x > canvas.width) return;
              const y = getY(o.entry);
              ctx.fillStyle = o.side === "LONG" ? "#0ecb81" : "#f6465d";
              ctx.beginPath();
              if (o.side === "LONG") {
                ctx.moveTo(x + this.zoom / 2, y + 5);
                ctx.lineTo(x + this.zoom / 2 - 5, y + 15);
                ctx.lineTo(x + this.zoom / 2 + 5, y + 15);
              } else {
                ctx.moveTo(x + this.zoom / 2, y - 5);
                ctx.lineTo(x + this.zoom / 2 - 5, y - 15);
                ctx.lineTo(x + this.zoom / 2 + 5, y - 15);
              }
              ctx.fill();
              ctx.font = "bold 9px Arial";
              ctx.fillText(
                o.side[0],
                x + this.zoom / 2 - 3,
                o.side === "LONG" ? y + 25 : y - 20,
              );
            });
          }
          ctx.fillStyle = "#2962ff";
          ctx.fillRect(canvas.width - 70, getY(this.price) - 10, 70, 20);
          ctx.fillStyle = "#fff";
          ctx.fillText(
            this.price.toFixed(2),
            canvas.width - 65,
            getY(this.price) + 4,
          );

          if (this.mouseX !== undefined) {
            ctx.setLineDash([2, 2]);
            ctx.strokeStyle = "rgba(255,255,255,0.2)";
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(0, this.mouseY);
            ctx.lineTo(canvas.width, this.mouseY);
            ctx.moveTo(this.mouseX, 0);
            ctx.lineTo(this.mouseX, canvas.height);
            ctx.stroke();
            ctx.setLineDash([]);

            // Tooltip t·ªça ƒë·ªô
            ctx.fillStyle = "#1e2329";
            ctx.fillRect(canvas.width - 70, this.mouseY - 10, 70, 20);
            ctx.fillStyle = "#fff";
            ctx.fillText(
              this.mousePrice.toFixed(2),
              canvas.width - 65,
              this.mouseY + 4,
            );
          }
        },
      };

      const Trade = {
        isLive: true,
        lastTrade: 0,
        orders: [],
        history: [],
        toggleMarket() {
          this.isLive = !this.isLive;
          document.getElementById("m-dot").className =
            `dot ${this.isLive ? "online" : "offline"}`;
          document.getElementById("m-txt").innerText = this.isLive
            ? "LIVE"
            : "OFF";
        },
        exec(side) {
          if (!this.isLive) return;
          if (Date.now() - this.lastTrade < 2000)
            return alert("Vui l√≤ng ƒë·ª£i 2s gi·ªØa c√°c l·ªánh");
          const lev = parseInt(document.getElementById("tr-lev").value);
          if (isNaN(lev) || lev < 1 || lev > 50)
            return alert("ƒê√≤n b·∫©y ph·∫£i t·ª´ 1 ƒë·∫øn 50!");
          const amt = parseFloat(document.getElementById("tr-amt").value);
          if (isNaN(amt) || amt <= 0) return alert("S·ªë ti·ªÅn kh√¥ng h·ª£p l·ªá!");
          if (amt > System.d.bal) return alert("S·ªë d∆∞ kh√¥ng ƒë·ªß!");

          System.d.bal -= amt;

          const order = {
            id: Date.now(),
            side,
            pair: Chart.symbol,
            entry: Chart.price,
            entryIdx: Chart.candles.length - 1,
            amt,
            lev,
          };
          this.orders.push(order);
          this.lastTrade = Date.now();
          this.renderOrders();
          Cloud.sync();
        },
        closeOrder(id) {
          const order = this.orders.find((o) => o.id === id);
          if (order) {
            const pnl =
              order.side === "LONG"
                ? Chart.price - order.entry
                : order.entry - Chart.price;
            let profit = (pnl / order.entry) * order.amt * order.lev;

            // Gi·ªõi h·∫°n l·ªó t·ªëi ƒëa b·∫±ng s·ªë ti·ªÅn ƒë·∫ßu t∆∞
            if (profit < -order.amt) profit = -order.amt;

            System.d.bal += order.amt + profit;

            this.history.unshift({
              ...order,
              exit: Chart.price,
              profit,
              time: new Date().toLocaleTimeString(),
            });
            if (this.history.length > 50) this.history.pop();
          }
          this.orders = this.orders.filter((o) => o.id !== id);
          this.renderOrders();
          this.renderHistory();
          Cloud.sync();
        },
        renderOrders() {
          const list = document.getElementById("order-list");
          document.getElementById("active-orders-count").innerText =
            this.orders.length;
          list.innerHTML = this.orders
            .map((o) => {
              const pnl =
                o.side === "LONG"
                  ? Chart.price - o.entry
                  : o.entry - Chart.price;
              const profit = (pnl / o.entry) * o.amt * o.lev;
              return `
                  <div class="order-row">
                    <span class="${o.side === "LONG" ? "o-side-long" : "o-side-short"}">
                      ${o.side} (${profit >= 0 ? "+" : ""}${profit.toFixed(2)})
                    </span>
                    <span>${o.pair}</span>
                    <span>Entry: ${o.entry.toFixed(2)}</span>
                    <button class="btn-close-order" onclick="Trade.closeOrder(${o.id})">CLOSE</button>
                  </div>
                `;
            })
            .join("");
        },
        renderHistory() {
          const list = document.getElementById("history-list");
          if (!list) return;
          list.innerHTML = this.history
            .map(
              (h) => `
            <div class="history-row">
              <span class="${h.side === "LONG" ? "o-side-long" : "o-side-short"}">${h.side[0]}</span>
              <span>${h.pair}</span>
              <span class="${h.profit >= 0 ? "h-win" : "h-loss"}">${h.profit >= 0 ? "+" : ""}${h.profit.toFixed(2)}</span>
              <span style="opacity:0.5">${h.time}</span>
            </div>
          `,
            )
            .join("");
        },
      };
    </script>
  </body>
</html>

